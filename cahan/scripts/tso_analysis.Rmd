---
title: Genome wide association study and differential gene expression of _Drosophila melanogaster_ under heat and cold stress
author: "TS O'Leary"
output:
  rmarkdown::html_document:
    theme: lumen
    number_sections: true
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
# don't show echos, warnings or messages
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# don't make the log files for the VennDiagram package
futile.logger::flog.threshold(futile.logger::ERROR, name = "VennDiagramLogger")

# load these required packages
require(tidyverse)
require(ggpubr)
require(seqsetvis)
require(ssvRecipes)
require(knitr)
require(kableExtra)

# source the functions and load the data
source(here::here("functions.R"))
source(here::here("cahan/scripts/load_data.R"))
```

# **Genome wide association study**

## Phenotypes

### Figure 1

```{r, fig.height = 5, fig.width = 7}
p1 <- ggplot(pheno %>%
               filter(type == "ctmin") %>%
               group_by(line_DGRP) %>%
               summarize(temp = mean(temp)), 
             aes(x = temp)) + 
        geom_histogram(binwidth = 0.33, color = "grey", alpha = 0.75) + 
        labs(x = expression(CT[min] * ~ "(°C)"),
             y = "Counts") +
        xlim(c(0, 10)) +
        ylim(c(0, 33)) + 
        annotate("text", x = 7.5, y = 17.5, label = expression(H^2 *" = 0.25"),
                 size = 4) +
        theme_classic()

p2 <- ggplot(pheno %>%
               filter(type == "ctmax") %>%
               group_by(line_DGRP) %>%
               summarize(temp = mean(temp)), 
             aes(x = temp)) + 
        geom_histogram(binwidth = 0.33, color = "grey", alpha = 0.75) + 
        labs(x = expression(CT[max] * ~ "(°C)"), 
             y = "Counts") +
        xlim(c(35, 45)) +
        ylim(c(0, 33)) +
        annotate("text", x = 42.5, y = 17.5, label = expression(H^2 *" = 0.29"),
                 size = 4) +
        theme_classic()

top_row <- cowplot::plot_grid(p1, p2, nrow = 1, labels = "AUTO")

my.formula <- y ~ x
p3 <- ggplot(pheno %>%
               pivot_wider(names_from = type, values_from = temp) %>%
               group_by(line_DGRP) %>%
               summarize(ctmin = mean(ctmin), ctmax = mean(ctmax)), 
             aes(x = ctmin, y = ctmax)) +
        geom_point(fill = "grey50", shape = 21) +
        geom_smooth(method = "lm", 
                    linetype = "dashed", 
                    se = FALSE, formula = my.formula, color = "grey50") +
        ggpmisc::stat_poly_eq(formula = my.formula, 
                              aes(label = ..rr.label..),
                              parse = TRUE, label.x = "right", label.y = "bottom") + 
        labs(x = expression(CT[min] * ~ "(°C)"), 
             y = expression(CT[max] * ~ "(°C)")) +
        theme_classic() +
        theme(plot.margin = unit(c(t = 0.25, r = 3.5, b = 0, l = 3.5), "cm"))

cowplot::plot_grid(top_row, p3, nrow = 2, labels = c("", "C"))
```


### Thermal Breadth Correlation

```{r, fig.height = 3.5, fig.width = 7}
my.formula <- y ~ x
p1 <- ggplot(pheno %>%
         pivot_wider(names_from = type, values_from = temp) %>%
         mutate(tb = ctmax - ctmin) %>%
         group_by(line_DGRP) %>%
         summarize(tb = mean(tb), ctmin = mean(ctmin), ctmax = mean(ctmax)), 
        aes(x = ctmin, y = tb)) +
        geom_point(fill = "grey50", shape = 21) +
        geom_smooth(method = "lm", 
                    linetype = "dashed", 
                    se = FALSE, formula = my.formula, color = "grey50") +
        ggpmisc::stat_poly_eq(formula = my.formula, 
                              aes(label = ..rr.label..),
                              parse = TRUE, label.x = 0.1, label.y = 0.95) + 
        labs(x = expression(CT[min] * ~ "(°C)"), 
             y = "Thermal Breadth (°C)") +
        theme_classic()
  

p2 <- ggplot(pheno %>%
         pivot_wider(names_from = type, values_from = temp) %>%
         mutate(tb = ctmax - ctmin) %>%
         group_by(line_DGRP) %>%
         summarize(tb = mean(tb), ctmin = mean(ctmin), ctmax = mean(ctmax)), 
        aes(x = ctmax, y = tb)) +
        geom_point(fill = "grey50", shape = 21) +
        geom_smooth(method = "lm", 
                    linetype = "dashed", 
                    se = FALSE, formula = my.formula, color = "grey50") +
        ggpmisc::stat_poly_eq(formula = my.formula, 
                              aes(label = ..rr.label..),
                              parse = TRUE, label.x = 0.1, label.y = 0.95) + 
        labs(x = expression(CT[max] * ~ "(°C)"), 
             y = "Thermal Breadth (°C)") +
        theme_classic()

cowplot::plot_grid(p1, p2, nrow = 1, labels = "AUTO")
```

## Manhattan plots

```{r, fig.height = 4.5, fig.width = 6}
p1 <- cowplot::ggdraw() +
  cowplot::draw_image(here::here("DRGP_GWAS/gwas_cold_manhattan.png"))

p2 <- cowplot::ggdraw() + 
  cowplot::draw_image(here::here("DRGP_GWAS/gwas_hot_manhattan.png"))

cowplot::plot_grid(p1, p2, nrow = 2, labels = "AUTO")
```

## **Strict cutoff 10<sup>-5</sup>**

### Summary

```{r}
# get only the SNPs identified in the GWAS
comb_hot_filt_5 <- deg_gwas_hot_5 %>%
  filter(!is.na(ID))

comb_cold_filt_5 <- deg_gwas_cold_5 %>%
  filter(!is.na(ID))


# create a column that indicates where the snps are from
comb_hot_filt_5$gwas <- "CTmax"
comb_cold_filt_5$gwas <- "CTmin"
gwas_tb_5$gwas <- "ThermalBreadth"


comb_gwas_5 <- dplyr::bind_rows(comb_hot_filt_5, comb_cold_filt_5, gwas_tb_5)


t1 <- comb_gwas_5 %>%
  group_by(gwas) %>%
  distinct(ID, .keep_all = TRUE) %>%
  dplyr::count() %>%
  dplyr::rename("SNPs" = n)

t2 <- comb_gwas_5 %>%
  group_by(gwas) %>%
  distinct(ID, .keep_all = TRUE) %>%
  dplyr::filter(gene != "") %>%
  dplyr::count() %>%
  dplyr::rename("SNPs annotated to genes" = n)

t3 <- comb_gwas_5 %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "") %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::count() %>%
  dplyr::rename("Unique genes" = n)

t4 <- comb_gwas_5 %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "") %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(padj <= 0.01) %>%
  dplyr::count() %>%
  dplyr::rename("Sig DEGs" = n)

t5 <- comb_gwas_5 %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "") %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(padj > 0.01) %>%
  dplyr::count() %>%
  dplyr::rename("NS DEGs" = n)

t6 <- comb_gwas_5 %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "" & is.na(baseMean) | baseMean == 0) %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::count() %>%
  dplyr::rename("No RNAseq data" = n)

t7 <- full_join(t1, t2) %>%
  full_join(t3) %>%
  full_join(t4) %>%
  full_join(t5) %>%
  full_join(t6)

t7$`No RNAseq data` <- t7$`No RNAseq data` %>% replace_na(0)

table <- t7 %>%
  dplyr::rename(GWAS = gwas) 

table %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

### Venn Diagram: SNPs & Genes

```{r, include = FALSE}
ctmin_snps <- comb_gwas_5$ID[comb_gwas_5$gwas == "CTmin"]
ctmax_snps <- comb_gwas_5$ID[comb_gwas_5$gwas == "CTmax"]
tb_snps <- comb_gwas_5$ID[comb_gwas_5$gwas == "ThermalBreadth"]

# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_snps, 
                              CTmax = ctmax_snps, 
                              ThermalBreadth = tb_snps),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max]),
                                             "Thermal Breadth"),
                          imagetype = "png",
                          filename = "gwas_5_venn_diagram.png",
                          fill = c("blue", "red", "purple"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red", "purple"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
# without thermal breadth
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_snps, 
                              CTmax = ctmax_snps),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max])),
                          imagetype = "png",
                          filename = "gwas_5_venn_diagram_ct.png",
                          fill = c("blue", "red"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```

```{r venn_diagram_5_genes, include = FALSE}
ctmin_genes <- comb_gwas_5 %>%
  dplyr::filter(gwas == "CTmin" & gene != "") %>%
  dplyr::distinct(gene)
ctmax_genes <- comb_gwas_5 %>%
  dplyr::filter(gwas == "CTmax" & gene != "") %>%
  dplyr::distinct(gene)
tb_genes <- comb_gwas_5 %>%
  dplyr::filter(gwas == "ThermalBreadth" & gene != "") %>%
  dplyr::distinct(gene)

# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_genes$gene, 
                              CTmax = ctmax_genes$gene, 
                              ThermalBreadth = tb_genes$gene),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max]),
                                             "Thermal Breadth"),                          
                          imagetype = "png",
                          filename = "gwas_5_genes_venn_diagram.png",
                          fill = c("blue", "red", "purple"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red", "purple"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
# without thermal breadth
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_genes$gene, 
                              CTmax = ctmax_genes$gene),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max])),                          
                          imagetype = "png",
                          filename = "gwas_5_genes_venn_diagram_ct.png",
                          fill = c("blue", "red"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 3,
                          cat.dist = .1,
                          margin = .1,
                          cex = 3,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```

```{r, fig.height = 3.5, fig.width = 7, fig.cap = "A) The top GWAS SNPs (10^-5) associated with each phenotype. B. The unique genes associated with those top SNPs"}

p1 <- cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/gwas_5_venn_diagram.png", 
                      scale = 0.9)

p2 <- cowplot::ggdraw() + 
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/gwas_5_genes_venn_diagram.png",
                      scale = 0.9)

cowplot::plot_grid(p1, p2, nrow = 1, labels = "AUTO")

```

Without thermal breadth

```{r, fig.height = 3.5, fig.width = 7, fig.cap = "A) The top GWAS SNPs (10^-5) associated with each phenotype. B. The unique genes associated with those top SNPs"}

p1 <- cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/gwas_5_venn_diagram_ct.png", 
                      scale = 0.9)

p2 <- cowplot::ggdraw() + 
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/gwas_5_genes_venn_diagram_ct.png",
                      scale = 0.9)

cowplot::plot_grid(p1, p2, nrow = 1, labels = "AUTO")

```

### CTmax

#### All hits

```{r}
gwas_hot_5 %>%
  dplyr::select(ID, gene, feature, pos, AvgEff, AvgMixedPval) %>%
  arrange(AvgMixedPval) %>%
  kable() %>%
  kable_styling("striped") %>% 
  scroll_box(width = "100%", height = "500px") %>%
  dplyr::rename("Distance to gene" = pos)
```

#### Feature count

```{r}
gwas_hot_5 %>%
  group_by(feature) %>%
  dplyr::count() %>%
  filter(feature != "") %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Gene counts

```{r}
gwas_hot_5 %>%
  dplyr::select(gene) %>%
  group_by(gene) %>%
  filter(gene != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```


### CTmin

#### All hits 

```{r}
gwas_cold_5 %>%
  dplyr::select(ID, gene, feature, pos, AvgEff, AvgMixedPval) %>%
  arrange(AvgMixedPval) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px") %>%
  dplyr::rename("Distance to gene" = pos)
```

#### Feature count

```{r}
gwas_cold_5 %>%
  group_by(feature) %>%
  filter(feature != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Gene counts

```{r}
gwas_cold_5 %>%
  dplyr::select(gene) %>%
  group_by(gene) %>%
  filter(gene != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

### Thermal Breadth

#### All hits

```{r}
gwas_tb %>%
  dplyr::select(ID, gene, feature, pos, AvgMixedPval) %>%
  arrange(AvgMixedPval) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px") %>%
  dplyr::rename("Distance to gene" = pos)
```

#### Feature count

```{r}
gwas_tb %>%
  group_by(feature) %>%
  filter(feature != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Gene counts

```{r}
gwas_tb %>%
  dplyr::select(gene) %>%
  group_by(gene) %>%
  filter(gene != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

## **Relaxed cutoff 10<sup>-4</sup>**

### Summary

```{r}
comb_cold_all <- full_join(res_cold, gwas_cold, by = "gene")
comb_hot_all <- full_join(res_hot, gwas_hot, by = "gene")


# get only the SNPs identified in the GWAS
comb_hot_filt <- comb_hot_all %>%
  filter(!is.na(ID))

comb_cold_filt <- comb_cold_all %>%
  filter(!is.na(ID))


# create a column that indicates where the snps are from
comb_hot_filt$gwas <- "CTmax"
comb_cold_filt$gwas <- "CTmin"
gwas_tb$gwas <- "ThermalBreadth"


comb_gwas <- dplyr::bind_rows(comb_hot_filt, comb_cold_filt, gwas_tb)


t1 <- comb_gwas %>%
  group_by(gwas) %>%
  distinct(ID, .keep_all = TRUE) %>%
  dplyr::count() %>%
  dplyr::rename("SNPs" = n)

t2 <- comb_gwas %>%
  group_by(gwas) %>%
  distinct(ID, .keep_all = TRUE) %>%
  dplyr::filter(gene != "") %>%
  dplyr::count() %>%
  dplyr::rename("SNPs annotated to genes" = n)

t3 <- comb_gwas %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "") %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::count() %>%
  dplyr::rename("Unique genes" = n)

t4 <- comb_gwas %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "") %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(padj <= 0.01) %>%
  dplyr::count() %>%
  dplyr::rename("Sig DEGs" = n)

t5 <- comb_gwas %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "") %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(padj > 0.01) %>%
  dplyr::count() %>%
  dplyr::rename("NS DEGs" = n)

t6 <- comb_gwas %>%
  group_by(gwas) %>%
  dplyr::filter(gene != "" & is.na(baseMean) | baseMean == 0) %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::count() %>%
  dplyr::rename("No RNAseq data" = n)

t7 <- full_join(t1, t2) %>%
  full_join(t3) %>%
  full_join(t4) %>%
  full_join(t5) %>%
  full_join(t6)

t7$`No RNAseq data` <- t7$`No RNAseq data` %>% replace_na(0)

table <- t7 %>%
  dplyr::rename(GWAS = gwas) 

table %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

### Venn Diagram: SNPs & Genes

```{r, include = FALSE}
ctmin_snps <- comb_gwas$ID[comb_gwas$gwas == "CTmin"]
ctmax_snps <- comb_gwas$ID[comb_gwas$gwas == "CTmax"]
tb_snps <- comb_gwas$ID[comb_gwas$gwas == "ThermalBreadth"]

# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_snps, 
                              CTmax = ctmax_snps, 
                              ThermalBreadth = tb_snps),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max]),
                                             "Thermal Breadth"),                          
                          imagetype = "png",
                          filename = "gwas_4_venn_diagram.png",
                          fill = c("blue", "red", "purple"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red", "purple"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")

# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_snps, 
                              CTmax = ctmax_snps),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max])),                          
                          imagetype = "png",
                          # main = "SNPs",
                          # main.cex = 6,
                          # main.fontfamily = "Arial",
                          # main.fontface = "bold",
                          filename = "gwas_4_venn_diagram_ct.png",
                          fill = c("blue", "red"), 
                          cat.pos = c(0,0),
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 5,
                          cat.dist = .05,
                          margin = 0,
                          cex = 4,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")

```

```{r, include = FALSE}
ctmin_genes <- comb_gwas %>%
  dplyr::filter(gwas == "CTmin" & gene != "") %>%
  dplyr::distinct(gene)
ctmax_genes <- comb_gwas %>%
  dplyr::filter(gwas == "CTmax" & gene != "") %>%
  dplyr::distinct(gene)
tb_genes <- comb_gwas %>%
  dplyr::filter(gwas == "ThermalBreadth" & gene != "") %>%
  dplyr::distinct(gene)

# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_genes$gene, 
                              CTmax = ctmax_genes$gene, 
                              ThermalBreadth = tb_genes$gene),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max]),
                                             "Thermal Breadth"),                          
                          imagetype = "png",
                          filename = "gwas_4_genes_venn_diagram.png",
                          fill = c("blue", "red", "purple"), 
                          cat.pos = c(330,30,180),
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red", "purple"), 
                          cat.fontfamily = "serif",
                          rotation = 3,
                          cat.fontface = "bold")

setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_genes$gene, 
                              CTmax = ctmax_genes$gene),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max])),                          
                          imagetype = "png",
                          # main = "Genes",
                          # main.cex = 6,
                          # main.fontfamily = "serif",
                          # main.fontface = "bold",
                          filename = "gwas_4_genes_venn_diagram_ct.png",
                          fill = c("blue", "red"),
                          cat.pos = c(0,0),
                          alpha = 0.5,
                          label.col = c("white", "grey50", "white"),
                          fontfamily = "serif",
                          fontface = "bold",
                          cat.cex = 5,
                          cat.dist = 0.05,
                          margin = 0,
                          cex = 4,
                          cat.col = c("blue", "red"),
                          cat.fontfamily = "serif",
                          cat.fontface = "bold",
                          ext.pos = 180,
                          ext.line.lwd = 3,
                          ext.dist = -0.2,
                          ext.length = 0.7)
```

```{r, fig.height = 3.5, fig.width = 7, fig.cap = "A) The top GWAS SNPs (10^-4) associated with each phenotype. B. The unique genes associated with those top SNPs"}

p1 <- cowplot::ggdraw() +
  cowplot::draw_image(here::here("cahan/plots/gwas_4_venn_diagram.png"), 
                      scale = 0.9)

p2 <- cowplot::ggdraw() + 
  cowplot::draw_image(here::here("cahan/plots/gwas_4_genes_venn_diagram.png"),
                      scale = 0.9)

cowplot::plot_grid(p1, p2, nrow = 1, labels = "AUTO")

```

Withouth thermal breadth

```{r, fig.height = 3.5, fig.width = 7, fig.cap = "A) The top GWAS SNPs (10^-4) associated with each phenotype. B. The unique genes associated with those top SNPs"}

p1 <- cowplot::ggdraw() +
  cowplot::draw_image(here::here("cahan/plots/gwas_4_venn_diagram_ct.png"), 
                      scale = 0.9)

p2 <- cowplot::ggdraw() + 
  cowplot::draw_image(here::here("cahan/plots/gwas_4_genes_venn_diagram_ct.png"),
                      scale = 0.9)

cowplot::plot_grid(p1, p2, nrow = 1, labels = "AUTO")

```

### CTmax

#### All hits

```{r}
gwas_hot %>%
  dplyr::select(ID, gene, feature, pos, AvgMixedPval) %>%
  arrange(AvgMixedPval) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px") %>%
  dplyr::rename("Distance to gene" = pos)
```

#### Feature count

```{r}
gwas_hot %>%
  group_by(feature) %>%
  dplyr::count() %>%
  filter(feature != "") %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Gene counts

```{r}
gwas_hot %>%
  dplyr::select(gene) %>%
  group_by(gene) %>%
  filter(gene != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

#### Non-differentially expressed GWAS hits

```{r}
gwas_hot %>%
  dplyr::filter(AvgMixedPval < 10^-4) %>%
  dplyr::select(gene, AvgMixedPval) %>%
  dplyr::arrange(gene, AvgMixedPval) %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::left_join(res_hot, by = "gene") %>%
  dplyr::select(gene, log2FoldChange, padj, AvgMixedPval) %>%
  dplyr::filter(padj > 0.01) %>%
  dplyr::arrange(AvgMixedPval) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```


### CTmin

#### All hits 

```{r}
gwas_cold %>%
  dplyr::select(ID, gene, feature, pos, AvgMixedPval) %>%
  arrange(AvgMixedPval) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px") %>%
  dplyr::rename("Distance to gene" = pos)
```

#### Feature count

```{r}
gwas_cold %>%
  group_by(feature) %>%
  filter(feature != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Gene counts

```{r}
gwas_cold %>%
  dplyr::select(gene) %>%
  group_by(gene) %>%
  filter(gene != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```


#### Non-differentially expressed GWAS hits

```{r}
gwas_cold %>%
  dplyr::filter(AvgMixedPval < 10^-4) %>%
  dplyr::select(gene, AvgMixedPval) %>%
  dplyr::arrange(gene, AvgMixedPval) %>%
  dplyr::distinct(gene, .keep_all = TRUE) %>%
  dplyr::left_join(res_cold, by = "gene") %>%
  dplyr::select(gene, log2FoldChange, padj, AvgMixedPval) %>%
  dplyr::filter(padj > 0.01) %>%
  dplyr::arrange(AvgMixedPval) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

### Thermal Breadth

#### All hits

```{r}
gwas_tb %>%
  dplyr::select(ID, gene, feature, pos, AvgMixedPval) %>%
  arrange(AvgMixedPval) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px") %>%
  dplyr::rename("Distance to gene" = pos)
```

#### Feature count

```{r}
gwas_tb %>%
  group_by(feature) %>%
  filter(feature != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Gene counts

```{r}
gwas_tb %>%
  dplyr::select(gene) %>%
  group_by(gene) %>%
  filter(gene != "") %>%
  dplyr::count() %>%
  arrange(desc(n)) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

```{r, fig.height = 4, fig.width = 4}
cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/deg_tf_venn_diagram.png")
```

## Transcription Factors

### CTmax

```{r}
ctmax_tf_df <- gwas_hot %>%
  dplyr::filter(AvgMixedPval < 10^-4) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::select(gene, AvgMixedPval) %>%
  dplyr::arrange(gene, AvgMixedPval) %>%
  dplyr::distinct(gene, .keep_all = TRUE) 

ctmax_deg_tf <- deg %>%
  dplyr::filter(gene %in% ctmax_tf_df$gene) %>%
  dplyr::select(gene, log2FoldChange.hot, padj.hot)

dplyr::full_join(ctmax_tf_df, ctmax_deg_tf) %>%
    mutate(padj.hot = cell_spec(padj.hot, "html", 
                                color = ifelse(padj.hot < 0.01, "red", "grey50")),
           log2FoldChange.hot = cell_spec(log2FoldChange.hot, "html", 
                                color = ifelse(log2FoldChange.hot > 0, "red", "blue"))) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

### CTmin

```{r}
ctmin_tf_df <- gwas_cold %>%
  dplyr::filter(AvgMixedPval < 10^-4) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::select(gene, AvgMixedPval) %>%
  dplyr::arrange(gene, AvgMixedPval) %>%
  dplyr::distinct(gene, .keep_all = TRUE) 

ctmin_deg_tf <- deg %>%
  dplyr::filter(gene %in% ctmin_tf_df$gene) %>%
  dplyr::select(gene, log2FoldChange.cold, padj.cold)

dplyr::full_join(ctmin_tf_df, ctmin_deg_tf) %>%
    mutate(padj.cold = cell_spec(padj.cold, "html", 
                                color = ifelse(padj.cold < 0.01, "red", "grey50")),
           log2FoldChange.cold = cell_spec(log2FoldChange.cold, "html", 
                                color = ifelse(log2FoldChange.cold > 0, "red", "blue"))) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

### Venn diagram

```{r, include = FALSE}
ctmin_tf <- gwas_cold %>%
  dplyr::filter(AvgMixedPval < 10^-4) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::select(gene)

ctmax_tf <- gwas_hot %>%
  dplyr::filter(AvgMixedPval < 10^-4) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::select(gene)


# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(CTmin = ctmin_tf$gene, 
                              CTmax = ctmax_tf$gene),
                          category.names = c(expression("CT"[min]),
                                             expression("CT"[max])),
                          imagetype = "png",
                          filename = "gwas_tf_venn_diagram.png",
                          fill = c("blue", "red"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```

```{r, fig.height = 4, fig.width = 4}
cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/gwas_tf_venn_diagram.png")
```

```{r, include = FALSE}
# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(HOT = hot_tf$gene,
                                   COLD = cold_tf$gene,
                                   CTmin = ctmin_tf$gene, 
                                   CTmax = ctmax_tf$gene),
                          category.names = c("COLD", "HOT", expression("CT"[min]),
                                             expression("CT"[max])),
                          imagetype = "png",
                          filename = "tf_venn_diagram.png",
                          fill = c("blue", "red", "blue", "red"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red", "blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```

```{r, fig.height = 4, fig.width = 4}
cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/tf_venn_diagram.png")
```

# **Expression**

## MA plots {.tabset .tabset-fade .tabset-pills}

All MA plots now have an FDR of 0.01 and no fold-change cutoff.

### No gene labels

**Cold v Ctrl MA plot**

```{r}
ggmaplot(res_cold, main = expression("4°C" %->% "25°C"),
         fdr = 0.01, fc = 0, size = 1,
         palette = c("#B31B21", "#1465AC", "#A6A6A680"),
         genenames = as.vector(res_cold$gene),
         legend = "top", top = 0,
         select.top.method = "padj",
         font.label = c("bold", 11), label.rectangle = TRUE,
         font.legend = "bold",
         font.main = "bold",
         ggtheme = ggplot2::theme_minimal()) + 
  theme(legend.text = element_text(size = 12))
```

**Hot v Ctrl MA plot**

```{r}
ggmaplot(res_hot, main = expression("37°C" %->% "25°C"),
         fdr = 0.01, fc = 0, size = 1,
         palette = c("#B31B21", "#1465AC", "#A6A6A680"),
         genenames = as.vector(res_hot$gene),
         legend = "top", top = 0,
         select.top.method = "padj",
         font.label = c("bold", 11), label.rectangle = TRUE,
         font.legend = "bold",
         font.main = "bold",
         ggtheme = ggplot2::theme_minimal()) + 
  theme(legend.text = element_text(size = 12))
```

### GWAS points

**Cold v Ctrl MA plot**

```{r}
deg_gwas_cold_distinct <- deg_gwas_cold %>%
  distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(baseMean > 0)

ggmaplot_gwas(deg_gwas_cold_distinct %>%
                distinct(gene, .keep_all = TRUE) %>%
                 dplyr::filter(baseMean > 0), 
              main = expression("4°C" %->% "25°C"),
              fdr = 0.01, fc = 0, size = 1,
              palette = c("#1465AC", "black", "#A6A6A680", "#B31B21"),
              genenames = as.vector(deg_gwas_cold_distinct$gene),
              legend = "top", top = 0,
              select.top.method = "gwas",
              font.label = c("bold", 11), label.rectangle = TRUE,
              font.legend = "bold",
              font.main = "bold",
              ggtheme = ggplot2::theme_minimal()) + 
  theme(legend.text = element_text(size = 12))
```

**Hot v Ctrl MA plot**

```{r}
deg_gwas_hot_distinct <- deg_gwas_hot %>%
  distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(baseMean > 0)

ggmaplot_gwas(deg_gwas_hot_distinct, main = expression("37°C" %->% "25°C"),
              fdr = 0.01, fc = 0, size = 1,
              palette = c("#1465AC", "black", "#A6A6A680", "#B31B21"),
              genenames = as.vector(deg_gwas_hot_distinct$gene),
              legend = "top", top = 0,
              select.top.method = "gwas",
              font.label = c("bold", 11), label.rectangle = TRUE,
              font.legend = "bold",
              font.main = "bold",
              ggtheme = ggplot2::theme_minimal()) + 
  theme(legend.text = element_text(size = 12))
```


### GWAS colored labels

**Cold v Ctrl MA plot**

```{r}
# color labels by deg

deg_gwas_cold_distinct <- deg_gwas_cold %>%
  distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(baseMean > 0)

ggmaplot_test(deg_gwas_cold_distinct, main = expression("4°C" %->% "25°C"),
              fdr = 0.01, fc = 0, size = 1,
              color_sig = TRUE,
              genenames = as.vector(deg_gwas_cold_distinct$gene),
              legend = "top", top = 22,
              select.top.method = "gwas",
              font.label = c("bold", 11), 
              font.label.sig = c(11, "bold", "firebrick"),
              label.rectangle = TRUE,
              font.legend = "bold",
              font.main = "bold",
              ggtheme = ggplot2::theme_minimal()) + 
  theme(legend.text = element_text(size = 12)) + 
  guides(color = guide_legend(override.aes = list(shape = 20)))
```

**Hot v Ctrl MA plot**

```{r}
# color labels by deg

deg_gwas_hot_distinct <- deg_gwas_hot %>%
  distinct(gene, .keep_all = TRUE) %>%
  dplyr::filter(baseMean > 0)

ggmaplot_test(deg_gwas_hot_distinct, main = expression("37°C" %->% "25°C"),
              fdr = 0.01, fc = 0, size = 1,
              color_sig = TRUE,
              genenames = as.vector(deg_gwas_hot_distinct$gene),
              legend = "top", top = 11,
              select.top.method = "gwas",
              font.label = c("bold", 11), 
              font.label.sig = c(11, "bold", "firebrick"),
              label.rectangle = TRUE,
              font.legend = "bold",
              font.main = "bold",
              ggtheme = ggplot2::theme_minimal()) + 
  theme(legend.text = element_text(size = 12)) + 
  guides(color = guide_legend(override.aes = list(shape = 20))) 
```

## Venn Diagrams

```{r}
res_cold_up <- res_cold %>%
  dplyr::filter(padj < 0.01 & log2FoldChange > 0)
res_hot_up <- res_hot %>%
  dplyr::filter(padj < 0.01 & log2FoldChange > 0)
res_cold_down <- res_cold %>%
  dplyr::filter(padj < 0.01 & log2FoldChange < 0)
res_hot_down <- res_hot %>%
  dplyr::filter(padj < 0.01 & log2FoldChange < 0)
```

### Up-regulated genes

```{r, fig.width = 5, fig.height = 3, include = FALSE}
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(COLD = res_cold_up$gene, 
                              HOT = res_hot_up$gene),
                          category.names = c("COLD", "HOT"),
                          imagetype = "png",
                          filename = "deg_hot_cold_up.png",
                          fill = c("blue", "red"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 1,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```

```{r}
cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/deg_hot_cold_up.png")
```

### Down-regulated genes

```{r, fig.width = 5, fig.height = 3,  include = FALSE}
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(COLD = res_cold_down$gene, 
                              HOT = res_hot_down$gene),
                          category.names = c("COLD", "HOT"),
                          imagetype = "png",
                          filename = "deg_hot_cold_down.png",
                          fill = c("blue", "red"), 
                          alpha = 0.5,
                          label.col = "white", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 1,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```

```{r}
cowplot::ggdraw() +
  cowplot::draw_image("/Users/tsoleary/R/rna_seq/cahan/plots/deg_hot_cold_down.png")
```


## Top 50 DEGs

[Download full DESeq2 gene expression results](https://tsoleary.github.io/rna_seq/cahan/results/deg_hot_cold.zip)

### Heat-shock

```{r}
deg_grouped %>%
  distinct(gene, .keep_all = TRUE) %>%
  group_by(hot_fc) %>%
  top_n(n = -50, wt = padj.hot) %>%
  dplyr::select(gene, hot_fc, log2FoldChange.hot, padj.hot) %>%
  arrange(hot_fc, padj.hot) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 4)))) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

### Cold-shock

```{r}
deg_grouped %>%
  group_by(cold_fc) %>%
  distinct(gene, .keep_all = TRUE) %>%
  top_n(n = -50, wt = padj.cold) %>%
  dplyr::select(gene, cold_fc, log2FoldChange.cold, padj.cold) %>%
  arrange(cold_fc, padj.cold) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 4)))) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

## Transription factors

### Summary

```{r}
# create a column that indicates where the deg
res_cold$deg <- "Cold"
res_hot$deg <- "Hot"


comb_deg <- dplyr::bind_rows(res_cold, res_hot)


t1 <- comb_deg %>%
  dplyr::filter(padj < 0.01) %>%
  dplyr::group_by(deg) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::count() %>%
  dplyr::rename("TFs" = n)

t2 <- comb_deg %>%
  dplyr::filter(padj < 0.01) %>%  
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::group_by(deg, log2FoldChange < 0) %>%
  dplyr::count() %>%
  dplyr::rename("TFs" = n) %>% 
  tidyr::pivot_wider(names_from = `log2FoldChange < 0`, values_from = TFs) %>%
  dplyr::rename("Down-regulated" = `TRUE`, "Up-regulated" = `FALSE`)
                    

table <- full_join(t1, t2)

table %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```

#### Heat-shock

```{r}
res_hot %>%
  dplyr::filter(padj < 0.01) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::group_by(log2FoldChange < 0) %>%
  dplyr::arrange(`log2FoldChange < 0`, desc(log2FoldChange)) %>%
  dplyr::ungroup() %>%
  dplyr::select(gene, log2FoldChange, padj) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 4)))) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

#### Cold-shock
```{r}
res_cold %>%
  dplyr::filter(padj < 0.01) %>%
  dplyr::filter(gene %in% dmel_tf$SYMBOL) %>%
  dplyr::group_by(log2FoldChange < 0) %>%
  dplyr::arrange(`log2FoldChange < 0`, desc(log2FoldChange)) %>%
  dplyr::ungroup() %>%
  dplyr::select(gene, log2FoldChange, padj) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 4)))) %>%
  kable() %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "500px")
```

#### Venn Diagram

```{r, include = FALSE}

# dont want it to evaluate every time
setwd(here::here("cahan/plots"))
VennDiagram::venn.diagram(x = list(COLD = cold_tf$gene, 
                              HOT = hot_tf$gene),
                          category.names = c("COLD", "HOT"),
                          imagetype = "png",
                          filename = "deg_tf_venn_diagram.png",
                          fill = c("blue", "red"), 
                          alpha = 0.5,
                          label.col = "black", 
                          fontfamily = "serif", 
                          fontface = "bold",
                          cat.cex = 2,
                          cat.dist = .1,
                          margin = .1,
                          cex = 2,
                          cat.col = c("blue", "red"), 
                          cat.fontfamily = "serif",
                          cat.fontface = "bold")
```




# **Integrate DEGs and GWAS**

## GWAS lfc expression density 

```{r, fig.height = 7, fig.width = 7}
# filter the gwas so there is only the pvalues that reach the cut off level ----
pval_cut_4 <- 10^-4

gwas_cold_4 <- gwas_cold %>%
  filter(AvgMixedPval < pval_cut_4)
gwas_hot_4 <- gwas_hot %>%
  filter(AvgMixedPval < pval_cut_4)

# create a data.frame with all the info for the plotting later -----------------
temp <- left_join(deg, gwas_cold_4, by = "gene", suffix = c("", ".cold"))
total_4 <- full_join(temp, gwas_hot_4, by = "gene", suffix = c(".cold", ".hot"))

# group by the significance
deg_grouped_4 <- group_deg(total_4, pval_cut = 0.01, lfc_cut = 0)


color_set <- c("goldenrod4", "goldenrod1", "coral4", "coral1", "grey50")

# the function from seqsetvis requires a sequential column in the data.frame
deg_grouped_4$id <- seq_len(nrow(deg_grouped_4))

deg_simple_4 <- deg_grouped_4 %>%
  dplyr::select(gene, log2FoldChange.hot, 
                log2FoldChange.cold, groupn, id, ID.hot, ID.cold) %>%
  mutate(gwas_g = case_when(is.na(ID.hot) & is.na(ID.cold) ~ "Other",
                            !is.na(ID.hot) & is.na(ID.cold)  ~ "CTmax",
                            is.na(ID.hot) & !is.na(ID.cold)  ~ "CTmin",
                            !is.na(ID.hot) & !is.na(ID.cold)  ~ "CTmin_CTmax"))

deg_simple_distinct_4 <- deg_simple_4 %>%
  distinct(gene, .keep_all = TRUE)


deg_simple_distinct_4 <- deg_simple_distinct_4 %>%
  separate(gwas_g, into = c("gwas_g", "gwas_g2"), sep = "_") %>%
  pivot_longer(gwas_g:gwas_g2, names_to = "type", values_to = "gwas_g", 
               values_drop_na = TRUE)

# order the levels of the factor for plotting purposes to get NS on bottom
deg_simple_distinct_4$groupn <- as.factor(deg_simple_distinct_4$groupn)

deg_simple_distinct_4$groupn <- factor(deg_simple_distinct_4$groupn, 
                                       levels =  c("Shared: 6228",
                                                   "Sig1 Shared: 3266", 
                                                   "Unique: 14",
                                                   "Sig1 Unique: 106",
                                                   "NS: 6485"))


plot_scatter_side_density_xy_rel(deg_simple_distinct_4, 
                             x_ = "log2FoldChange.cold", 
                             y_ = "log2FoldChange.hot",
                             labs_x = "Cold vs Ctrl (Log2 fold-change)",
                             labs_y = "Hot vs Ctrl (Log2 fold-change)",
                             bg.string = "NS: 6485",
                             bg.density.string = "Other",
                             labs_sets_density = "Top GWAS-associated genes",
                             id_ = "id", 
                             set_ = "groupn", 
                             set_density_ = "gwas_g", 
                             sets.density.colors = c("red", "blue", "yellow"),
                             sets.colors = color_set,
                             n_auto_label = 0)
```

## Density plot overlay

```{r, fig.height = 4, fig.width = 7}
ggplot(deg_simple_distinct_4) +
  geom_line(mapping = aes(x = log2FoldChange.hot, color = gwas_g), 
            data = deg_simple_distinct_4 %>%
              dplyr::filter(gwas_g != "CTmin"), stat = "density") +
  geom_line(mapping = aes(x = log2FoldChange.cold, color = gwas_g), 
            linetype = "dashed", data = deg_simple_distinct_4 %>%
              dplyr::filter(gwas_g != "CTmax"), stat = "density") +
  scale_color_manual(values = c("red", "blue", "grey50"), drop = FALSE) +
  labs(x = "log2FoldChange vs. Ctrl", 
       color = "GWAS", 
       caption = "Cold dashed line\nHot solid line") +
  theme_classic()
```

## KS test

```{r}
# do comparison for both hot and cold
tab_hot <- ks.pairwise(deg_simple_distinct_4, "log2FoldChange.hot") 
tab_cold <- ks.pairwise(deg_simple_distinct_4, "log2FoldChange.cold")
df <- cbind(tab_hot, tab_cold[2])
colnames(df) <- c("GWAS distributions", "Heat-shock", "Cold-shock")

# create a table for the output
df %>%
  kable(caption = 
          "K.S. pairwise comparisons of the distributions of top GWAS genes under shock") %>%
  kable_styling("striped") %>%
  scroll_box(width = "100%", height = "100%")
```
